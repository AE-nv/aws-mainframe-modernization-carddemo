@page "/customers"
@using CardDemo.POC.Web.Data.Entities
@using CardDemo.POC.Web.Services
@inject CustomerService CustomerService
@inject ILogger<Customers> Logger

<PageTitle>Customers - CardDemo POC</PageTitle>

<div class="page-header">
    <h1 class="page-title">ðŸ‘¥ Customer Management</h1>
    <button class="btn-add" @onclick="ShowAddCustomerForm">
        <span class="oi oi-plus"></span> Add Customer
    </button>
</div>

@if (showForm)
{
    <div class="form-overlay" @onclick="CancelForm">
        <div class="form-modal" @onclick:stopPropagation="true">
            <div class="form-header">
                <h2>@(isEditing ? "Edit Customer" : "New Customer")</h2>
                <button class="btn-close" @onclick="CancelForm">âœ•</button>
            </div>
            
            <div class="form-body">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert-error">@errorMessage</div>
                }

                <div class="form-grid">
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        <div class="form-group">
                            <label>Customer ID *</label>
                            <input type="text" @bind="currentCustomer.CustomerId" 
                                   disabled="@isEditing" maxlength="9" 
                                   placeholder="9 digits" class="form-control" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name *</label>
                                <input type="text" @bind="currentCustomer.FirstName" 
                                       maxlength="25" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Middle Name</label>
                                <input type="text" @bind="currentCustomer.MiddleName" 
                                       maxlength="25" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Last Name *</label>
                                <input type="text" @bind="currentCustomer.LastName" 
                                       maxlength="25" class="form-control" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="date" @bind="currentCustomer.DateOfBirth" 
                                       class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>SSN</label>
                                <input type="text" @bind="currentCustomer.SSN" 
                                       maxlength="9" placeholder="9 digits" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>FICO Score *</label>
                                <input type="number" @bind="currentCustomer.FicoCreditScore" 
                                       min="300" max="850" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Contact Information</h3>
                        <div class="form-group">
                            <label>Address Line 1</label>
                            <input type="text" @bind="currentCustomer.AddressLine1" 
                                   maxlength="50" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Address Line 2</label>
                            <input type="text" @bind="currentCustomer.AddressLine2" 
                                   maxlength="50" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Address Line 3</label>
                            <input type="text" @bind="currentCustomer.AddressLine3" 
                                   maxlength="50" class="form-control" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>State</label>
                                <input type="text" @bind="currentCustomer.StateCode" 
                                       maxlength="2" placeholder="2 letters" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>ZIP Code</label>
                                <input type="text" @bind="currentCustomer.ZipCode" 
                                       maxlength="10" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" @bind="currentCustomer.CountryCode" 
                                       maxlength="3" placeholder="3 letters" class="form-control" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone 1</label>
                                <input type="tel" @bind="currentCustomer.PhoneNumber1" 
                                       maxlength="15" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Phone 2</label>
                                <input type="tel" @bind="currentCustomer.PhoneNumber2" 
                                       maxlength="15" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Additional Information</h3>
                        <div class="form-group">
                            <label>Government ID</label>
                            <input type="text" @bind="currentCustomer.GovernmentIssuedId" 
                                   maxlength="20" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>EFT Account ID</label>
                            <input type="text" @bind="currentCustomer.EftAccountId" 
                                   maxlength="10" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Primary Cardholder</label>
                            <select @bind="currentCustomer.PrimaryCardholderIndicator" class="form-control">
                                <option value="Y">Yes</option>
                                <option value="N">No</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-footer">
                <button class="btn-secondary" @onclick="CancelForm">Cancel</button>
                <button class="btn-primary" @onclick="SaveCustomer" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>@(isEditing ? "Update" : "Create") Customer</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<div class="data-table-container">
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading customers...</p>
        </div>
    }
    else if (customers.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">ðŸ“‹</div>
            <h3>No customers yet</h3>
            <p>Get started by adding your first customer</p>
            <button class="btn-primary" @onclick="ShowAddCustomerForm">
                <span class="oi oi-plus"></span> Add Customer
            </button>
        </div>
    }
    else
    {
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Customer ID</th>
                        <th>Name</th>
                        <th>Date of Birth</th>
                        <th>Phone</th>
                        <th>City/State</th>
                        <th>FICO Score</th>
                        <th>Accounts</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var customer in customers)
                    {
                        <tr>
                            <td><span class="id-badge">@customer.CustomerId</span></td>
                            <td><strong>@customer.FullName</strong></td>
                            <td>@(customer.DateOfBirth?.ToString("MM/dd/yyyy") ?? "-")</td>
                            <td>@(string.IsNullOrEmpty(customer.PhoneNumber1) ? "-" : customer.PhoneNumber1)</td>
                            <td>@(string.IsNullOrEmpty(customer.StateCode) ? "-" : customer.StateCode)</td>
                            <td><span class="score-badge score-@GetScoreClass(customer.FicoCreditScore)">@customer.FicoCreditScore</span></td>
                            <td><span class="count-badge">@customer.Accounts.Count</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon btn-edit" @onclick="() => EditCustomer(customer)" title="Edit">
                                        <span class="oi oi-pencil"></span>
                                    </button>
                                    <button class="btn-icon btn-delete" @onclick="() => DeleteCustomer(customer)" title="Delete">
                                        <span class="oi oi-trash"></span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="table-footer">
            <p>Showing @customers.Count customer(s)</p>
        </div>
    }
</div>

@code {
    private List<Customer> customers = new();
    private Customer currentCustomer = new();
    private bool showForm = false;
    private bool isEditing = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        try
        {
            isLoading = true;
            customers = await CustomerService.GetAllCustomersAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading customers");
            errorMessage = "Failed to load customers. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddCustomerForm()
    {
        currentCustomer = new Customer 
        { 
            FicoCreditScore = 650,
            PrimaryCardholderIndicator = "Y"
        };
        isEditing = false;
        errorMessage = string.Empty;
        showForm = true;
    }

    private void EditCustomer(Customer customer)
    {
        currentCustomer = new Customer
        {
            CustomerId = customer.CustomerId,
            FirstName = customer.FirstName,
            MiddleName = customer.MiddleName,
            LastName = customer.LastName,
            AddressLine1 = customer.AddressLine1,
            AddressLine2 = customer.AddressLine2,
            AddressLine3 = customer.AddressLine3,
            StateCode = customer.StateCode,
            CountryCode = customer.CountryCode,
            ZipCode = customer.ZipCode,
            PhoneNumber1 = customer.PhoneNumber1,
            PhoneNumber2 = customer.PhoneNumber2,
            SSN = customer.SSN,
            GovernmentIssuedId = customer.GovernmentIssuedId,
            DateOfBirth = customer.DateOfBirth,
            EftAccountId = customer.EftAccountId,
            PrimaryCardholderIndicator = customer.PrimaryCardholderIndicator,
            FicoCreditScore = customer.FicoCreditScore
        };
        isEditing = true;
        errorMessage = string.Empty;
        showForm = true;
    }

    private async Task SaveCustomer()
    {
        try
        {
            isSaving = true;
            errorMessage = string.Empty;

            if (isEditing)
            {
                await CustomerService.UpdateCustomerAsync(currentCustomer);
            }
            else
            {
                await CustomerService.CreateCustomerAsync(currentCustomer);
            }

            await LoadCustomers();
            showForm = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving customer");
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteCustomer(Customer customer)
    {
        if (customer.Accounts.Count > 0)
        {
            errorMessage = $"Cannot delete customer {customer.CustomerId} - customer has {customer.Accounts.Count} account(s). Delete accounts first.";
            return;
        }

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete customer {customer.FullName} ({customer.CustomerId})?");
        
        if (confirmed)
        {
            try
            {
                await CustomerService.DeleteCustomerAsync(customer.CustomerId);
                await LoadCustomers();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting customer");
                errorMessage = $"Failed to delete customer: {ex.Message}";
            }
        }
    }

    private void CancelForm()
    {
        showForm = false;
        errorMessage = string.Empty;
    }

    private string GetScoreClass(int score)
    {
        if (score >= 750) return "excellent";
        if (score >= 700) return "good";
        if (score >= 650) return "fair";
        return "poor";
    }
}

@inject IJSRuntime JSRuntime
